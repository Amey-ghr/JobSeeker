<div class="container my-5">
  <h2 class="mb-4">Applications Management</h2>

  <input
    type="text"
    id="searchApplicationInput"
    class="form-control mb-3"
    placeholder="Search by Job Title..."
  />

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Job Title</th>
        <th>Profile</th>
        <th>Apply Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="applicationsTableBody"></tbody>
  </table>

  <script>
    (function () {
      const baseUrl = "http://localhost:8080/api";
      setTimeout(() => {
        const applicationUrl = `${baseUrl}/applications`;
        const jobUrl = `${baseUrl}/jobs`;
        const companyUrl = `${baseUrl}/companies`;
        const userUrl = `${baseUrl}/users`

        let allApplications = [];
        let allJobs = [];
        let allUsers = [];
        let userCompany = null;

        const currentEmployerId = getUserId();
        const searchApplicationInput = document.getElementById(
          "searchApplicationInput"
        );

        function fetchData() {
          fetch(companyUrl)
            .then((res) => res.json())
            .then((companies) => {
              userCompany = companies.find(
                (c) => c.userID === currentEmployerId
              );
              if (userCompany) {
                fetch(jobUrl)
                  .then((res) => res.json())
                  .then((jobs) => {
                    allJobs = jobs.filter(
                      (job) => job.CompanyID === userCompany.id
                    );
                    fetch(applicationUrl)
                      .then((res) => res.json())
                      .then((applications) => {
                        allApplications = applications.filter((app) =>
                          allJobs.some((job) => job.id === app.jobId)
                        );

                        fetch(userUrl)
                          .then((res) => res.json())
                          .then((users) => {
                            allUsers = users;
                            renderApplications();
                          });
                      });
                  });
              }
            });
        }

        function renderApplications() {
          const tbody = document.getElementById("applicationsTableBody");
          if (!tbody) return;
          tbody.innerHTML = "";

          allApplications.forEach((application) => {
            const job = allJobs.find((job) => job.id === application.jobId);
            const user = allUsers.find(
              (user) => user.id === application.userId
            );
            const resumeLink = user?.Linkedin
              ? `<a href="${user.Linkedin}" target="_blank">View Resume</a>`
              : "N/A";
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${job.Title}</td>
              <td>${resumeLink}</td> 
              <td>${new Date(application.appliedDate).toLocaleDateString()}</td>
              <td>${application.status}</td>
              <td>
                ${
                  application.status === "pending"
                    ? `
                  <button class="btn btn-sm btn-success me-1 approve-btn" data-id="${application.id}">
                    Approve
                  </button>
                  <button class="btn btn-sm btn-danger me-1 reject-btn" data-id="${application.id}">
                    Reject
                  </button>
                `
                    : ""
                }
                
              </td>
              
            `;
            tbody.appendChild(row);
          });

          document.querySelectorAll(".approve-btn").forEach((btn) => {
            btn.addEventListener("click", () =>
              updateStatus(btn.dataset.id, "approved")
            );
          });

          document.querySelectorAll(".reject-btn").forEach((btn) => {
            btn.addEventListener("click", () =>
              updateStatus(btn.dataset.id, "rejected")
            );
          });
        }

        function updateStatus(id, newStatus) {
          const application = allApplications.find((app) => app.id === id);
          if (!application) return;

          fetch(`${applicationUrl}/${id}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              ...application,
              status: newStatus,
            }),
          })
            .then(() => fetchData())
            .catch((err) => console.error("Error updating status:", err));
        }

        searchApplicationInput.addEventListener("input", () => {
          const searchTerm = searchApplicationInput.value.toLowerCase();
          const filtered = allApplications.filter((application) => {
            const job = allJobs.find((job) => job.id === application.jobId);
            return job && job.Title.toLowerCase().includes(searchTerm);
          });
          renderApplications(filtered);
        });

        fetchData();
      }, 0);
    })();
  </script>
</div>
