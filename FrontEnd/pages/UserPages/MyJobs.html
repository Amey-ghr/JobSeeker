<div class="container my-5">
  <h2 class="mb-4">Your Applied Jobs</h2>

  <input type="text" id="searchAppliedJobInput" class="form-control mb-3" placeholder="Search by Job Title..."/>

  <table class="table table-bordered">
    <thead>
      <tr>
        <th>Job Title</th>
        <th>Apply Date</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="appliedJobsTableBody"></tbody>
  </table>

  <script>
    (function () {
      setTimeout(() => {
        const applicationUrl = "http://localhost:3000/Applications";
        const jobUrl = "http://localhost:3000/Jobs";
        let allApplications = [];
        let allJobs = [];
        
        
        const currentUserId = getUserId(); 

        const searchAppliedJobInput = document.getElementById("searchAppliedJobInput");

        function fetchAndRenderAppliedJobs() {
          fetch(applicationUrl)
            .then(res => res.json())
            .then(applicationsData => {
              allApplications = applicationsData.filter(app => app.userId === currentUserId);
              fetchJobsAndRender(allApplications);
            })
            .catch(err => console.error("Error fetching applications:", err));
        }

        function fetchJobsAndRender(applicationsData) {
          fetch(jobUrl)
            .then(res => res.json())
            .then(jobsData => {
              allJobs = jobsData;
              renderAppliedJobs(applicationsData, jobsData);
            })
            .catch(err => console.error("Error fetching jobs:", err));
        }

        function renderAppliedJobs(applications, jobs) {
          const tbody = document.getElementById("appliedJobsTableBody");
          if (!tbody) return;
          tbody.innerHTML = "";

          applications.forEach(application => {
            const job = jobs.find(job => job.id === application.jobId);
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${job.Title}</td>
              <td>${new Date(application.appliedDate).toLocaleDateString()}</td>
              <td>${application.status}</td>
              <td>
                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${application.id}">
                  Delete
                </button>
              </td>
            `;
            tbody.appendChild(row);
          });

          // Add event listeners to delete buttons
          document.querySelectorAll(".delete-btn").forEach(btn => {
            btn.addEventListener("click", () => deleteApplication(btn.dataset.id));
          });
        }

        function deleteApplication(id) {
          if (confirm("Are you sure you want to delete this application?")) {
            fetch(`${applicationUrl}/${id}`, { 
              method: "DELETE" 
            })
            .then(() => fetchAndRenderAppliedJobs())
            .catch(err => console.error("Error deleting application:", err));
          }
        }

        // Search functionality
        searchAppliedJobInput.addEventListener("input", () => {
          const searchTerm = searchAppliedJobInput.value.toLowerCase();
          const filtered = allApplications.filter(application => {
            const job = allJobs.find(job => job.id === application.jobId);
            return job && job.Title.toLowerCase().includes(searchTerm);
          });
          renderAppliedJobs(filtered, allJobs);
        });

        // Initialize
        fetchAndRenderAppliedJobs();
      }, 0);
    })();
  </script>
</div>