<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Job Seeker Dashboard -->
<div class="container mt-4">
  <h2 class="mb-4">Job Seeker Dashboard</h2>

  <!-- Top Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h5 class="card-title">Jobs Available</h5>
          <p class="card-text fs-4" id="jobsAvailable">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5 class="card-title">Applications Submitted</h5>
          <p class="card-text fs-4" id="applicationsSubmitted">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h5 class="card-title">Interviews Scheduled</h5>
          <p class="card-text fs-4" id="interviewsScheduled">0</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-danger">
        <div class="card-body">
          <h5 class="card-title">Offers Received</h5>
          <p class="card-text fs-4" id="offersCount">0</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-4">

    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">My Application Status</h5>
          <canvas id="statusPieChart" height="300"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title">Applications by Industry</h5>
          <canvas id="industryBarChart" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
(function() {
  const jobsUrl         = "http://localhost:3000/Jobs";
  const applicationsUrl = "http://localhost:3000/Applications";
  const companiesUrl    = "http://localhost:3000/Companies";
  const currentUserId   = getUserId(); 

  function fetchDashboardData() {
    console.log("Fetching dashboard data…");
    Promise.all([
      fetch(jobsUrl).then(r => r.json()),
      fetch(applicationsUrl).then(r => r.json()),
      fetch(companiesUrl).then(r => r.json())
    ])
    .then(([jobs, applications, companies]) => {
      console.log("Data loaded:", { jobs: jobs.length, applications: applications.length, companies: companies.length });

      // Metrics
      document.getElementById('jobsAvailable').textContent =
        jobs.length;

      const myApps = applications.filter(app => app.userId === currentUserId);
      document.getElementById('applicationsSubmitted').textContent =
        myApps.length;

      // document.getElementById('interviewsScheduled').textContent =
      //   myApps.filter(a => a.status === 'reviewed').length;

      document.getElementById('offersCount').textContent =
        myApps.filter(a => a.status === 'approved').length;

      // Charts
      renderCharts(myApps, jobs, companies);
    })
    .catch(err => console.error("Dashboard fetch error:", err));
  }

  function renderCharts(apps, jobs, companies) {
    // Pie – status
    const statusCounts = {
      pending:   apps.filter(a => a.status==='pending').length,
      // reviewed:  apps.filter(a => a.status==='reviewed').length,
      approved:  apps.filter(a => a.status==='approved').length,
      rejected:  apps.filter(a => a.status==='rejected').length
    };
    if (window.statusPie) window.statusPie.destroy();
    window.statusPie = new Chart(
      document.getElementById('statusPieChart'),
      { type:'pie', data: { labels:Object.keys(statusCounts),
          datasets:[{ data:Object.values(statusCounts) }] }
      }
    );

    // Bar – by industry
    const industryMap = {};
    companies.forEach(c => industryMap[c.id]=c.industry);
    const industryCounts = {};
    apps.forEach(a => {
      const job = jobs.find(j=>j.id===a.jobId);
      const ind = job ? industryMap[job.CompanyID]||'Other' : 'Unknown';
      industryCounts[ind] = (industryCounts[ind]||0) + 1;
    });
    if (window.industryBar) window.industryBar.destroy();
    window.industryBar = new Chart(
      document.getElementById('industryBarChart'),
      {
        type:'bar',
        data:{
          labels: Object.keys(industryCounts),
          datasets:[{ label:'Applications', data:Object.values(industryCounts) }]
        },
        options:{ scales:{ y:{ beginAtZero:true, ticks:{ stepSize:1 } } } }
      }
    );
  }

  fetchDashboardData();
})();
</script>
